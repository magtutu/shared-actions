name: On Merge Pipeline

on:
  workflow_call:
    inputs:
      app-name:
        required: true
        type: string

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest
    steps:
    - name: Check secret and variable access (app-merge)
      shell: bash
      env:
        DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}
        DEPLOY_INFO: ${{ vars.DEPLOY_INFO }}
        GH_PAT: ${{ secrets.GH_PAT }}
      run: |
        echo "================================"
        echo DEPLOY_TOKEN: ${DEPLOY_TOKEN}
        echo DEPLOY_INFO: ${DEPLOY_INFO}
        if [ -z "$GH_PAT" ]; then
          echo "❌ GH_PAT is NOT accessible"
        else
          echo "✅ GH_PAT is accessible"
        fi
        echo "================================"

    - name: Extract calling repository
      id: repo-info
      run: |
        WORKFLOW_REF="${{ github.workflow_ref }}"
        echo "Workflow ref: $WORKFLOW_REF"
        
        # Extract owner/repo from workflow_ref
        # Format: owner/repo/.github/workflows/workflow.yml@ref
        CALLING_REPO=$(echo "$WORKFLOW_REF" | cut -d'/' -f1-2)
        echo "calling-repo=$CALLING_REPO" >> $GITHUB_OUTPUT
        echo "Calling repo: $CALLING_REPO"

    - name: Checkout calling repository
      uses: actions/checkout@v4
      with:
        repository: ${{ steps.repo-info.outputs.calling-repo }}
        token: ${{ secrets.GH_PAT }}
        path: app

    - name: Run make build
      working-directory: app
      run: make build

  deploy-staging:
    name: Deploy to Staging
    needs: build
    permissions:
      id-token: write
    uses: ./.github/workflows/app-deploy.yml
    with:
      environment: staging
      app-name: ${{ inputs.app-name }}

  approve-production:
    name: Approve Production Deployment
    needs: deploy-staging
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Approval gate
        run: |
          echo "✅ Production deployment approved"
          echo "Proceeding to production deployment..."

  deploy-production:
    name: Deploy to Production
    needs: approve-production
    permissions:
      id-token: write
    uses: ./.github/workflows/app-deploy.yml
    with:
      environment: production
      app-name: ${{ inputs.app-name }}
