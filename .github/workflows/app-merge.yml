name: On Merge Pipeline

on:
  workflow_call:
    inputs:
      app-name:
        description: Application name to deploy
        required: true
        type: string

jobs:
  debug-env:
    name: Debug Environment Variables
    runs-on: ubuntu-latest
    steps:
      - name: Print environment variables
        run: |
          echo "üîç Environment Variables in shared-actions app-merge workflow:"
          echo "================================"
          env | sort
  
  deploy-staging:
    name: Deploy to Staging
    needs: debug-env
    permissions:
      id-token: write
    uses: ./.github/workflows/app-deploy.yml
    with:
      environment: staging
      app-name: ${{ inputs.app-name }}
  
  approve-production:
    name: Approve Production Deployment
    needs: deploy-staging
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Approval gate
        run: |
          echo "‚úÖ Production deployment approved"
          echo "Proceeding to production deployment..."
  
  deploy-production:
    name: Deploy to Production
    needs: approve-production
    permissions:
      id-token: write
    uses: ./.github/workflows/app-deploy.yml
    with:
      environment: production
      app-name: ${{ inputs.app-name }}
