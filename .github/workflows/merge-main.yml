name: Merge to Main Pipeline

on:
  workflow_call:
    inputs:
      app-name:
        description: Application name to deploy
        required: true
        type: string

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check secret access (no environment)
        env:
          DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}
        run: |
          echo "üîç Checking secret access in validate job (no environment)..."
          if [ -z "$DEPLOY_TOKEN" ]; then
            echo "‚ùå DEPLOY_TOKEN is NOT accessible"
          else
            echo "‚úÖ DEPLOY_TOKEN is accessible: ${DEPLOY_TOKEN:0:10}..."
          fi
      
      - name: Run validation
        run: |
          echo "üîç Running validation checks..."
          echo "‚úì Validation passed"
  
  deploy-staging:
    name: Deploy to Staging
    needs: validate
    uses: ./.github/workflows/deploy.yml
    with:
      environment: staging
      app-name: ${{ inputs.app-name }}
  
  approve-production:
    name: Approve Production Deployment
    needs: deploy-staging
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Check secret access (production environment)
        env:
          DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}
        run: |
          echo "üîç Checking secret access in approval job (production environment)..."
          if [ -z "$DEPLOY_TOKEN" ]; then
            echo "‚ùå DEPLOY_TOKEN is NOT accessible"
          else
            echo "‚úÖ DEPLOY_TOKEN is accessible: ${DEPLOY_TOKEN:0:10}..."
          fi
      
      - name: Approval gate
        run: |
          echo "‚úÖ Production deployment approved"
          echo "Proceeding to production deployment..."
  
  deploy-production:
    name: Deploy to Production
    needs: approve-production
    uses: ./.github/workflows/deploy.yml
    with:
      environment: production
      app-name: ${{ inputs.app-name }}
